generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "mysql"
}

enum BoardType {
  GUIDE
  DOCTRINE
  FITTING
  MARKET
}

enum FileStatus {
  uploaded
  optimized
}

enum UploadStatus {
  pending
  completed
  failed
  expired
}

model Users {
  id                BigInt          @id @default(autoincrement())
  character_id      BigInt          @unique
  nickname          String          @unique @db.VarChar(64)
  corp              Int
  refresh_token     String          @db.VarChar(64)
  access_expires_at DateTime?
  last_login_at     DateTime?
  last_login_ip     String?         @db.VarChar(45)
  scopes            String?         @db.VarChar(255)
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  Role              String?         @db.VarChar(64)

  upload_sessions   UploadSession[]
  boards            board[]         @relation("UserBoards")

  @@map("users")
}

model File {
  id            BigInt       @id @default(autoincrement())
  file_md5      String       @unique
  original_name String?
  extension     String
  size          BigInt
  s3_key        String
  s3_url        String
  status        FileStatus   @default(uploaded)
  need_optimize Boolean      @default(true)
  ref_count     Int          @default(0)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  sessions      UploadSession[]

  @@map("file")
}

model UploadSession {
  id            BigInt       @id @default(autoincrement())
  file_md5      String
  original_name String?
  extension     String
  size          BigInt
  s3_key        String
  status        UploadStatus @default(pending)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  user_id       BigInt
  user          Users  @relation(fields: [user_id], references: [character_id], onDelete: Cascade)

  file_id       BigInt?
  file          File?   @relation(fields: [file_id], references: [id], onDelete: SetNull)

  @@index([file_md5, status, created_at])
  @@index([file_id])
  @@index([user_id])
  @@map("uploadSession")
}

model board {
  id             BigInt   @id @default(autoincrement())
  type           BoardType
  character_id   BigInt 
  board_title    String   @db.VarChar(200)
  board_content  Json                  
  create_dt      DateTime @default(now())               
  recommend_cnt  Int      @default(0)

  user users @relation("UserBoards", fields: [character_id], references: [character_id], onDelete: Cascade)

  @@index([type, create_dt])
  @@map("board")
}
