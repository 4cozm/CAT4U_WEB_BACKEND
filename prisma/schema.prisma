generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}
datasource db {
  provider = "mysql"
}


model Users {
  id                BigInt          @id @default(autoincrement())
  character_id      BigInt          @unique
  nickname          String          @unique @db.VarChar(64)
  corp              Int
  refresh_token     String          @db.VarChar(64)
  access_expires_at DateTime?
  last_login_at     DateTime?
  last_login_ip     String?         @db.VarChar(45)
  scopes            String?         @db.VarChar(255)
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  Role              String?         @db.VarChar(64)

  upload_sessions   UploadSession[]
  boards            Board[]  @relation("Boards/User")
  board_likes       BoardLike[]
  comments Comment[] @relation("Comment/User")

  @@map("users")
}

enum BoardType {
  GUIDE
  DOCTRINE
  FITTING
  MARKET
}


enum FileStatus {
  uploaded
  optimized
}

enum UploadStatus {
  pending
  completed
  failed
  expired
}

model Board {
  id              BigInt    @id @default(autoincrement())
  type            BoardType
  nickname String @db.VarChar(64)
  board_title     String    @db.VarChar(200)

  board_content   Json

  create_dt       DateTime  @default(now())
  recommend_cnt   Int       @default(0)
  is_deleted      Int       @default(0) @db.TinyInt
  updated_dt      DateTime  @updatedAt
  last_editor_name  String?

  user            Users     @relation("Boards/User", fields: [nickname], references: [nickname], onDelete: Cascade)

  histories       BoardHistory[]
  likes           BoardLike[]
  comments Comment[] @relation("Comment/Board")
  
  @@index([id, type])
  @@index([type, create_dt])
  @@index([is_deleted])
  @@map("board")
}

model BoardHistory {
  id              BigInt   @id @default(autoincrement())
  board_id        BigInt

  prev_title      String   @db.VarChar(200)

  // 당시 원본 JSON
  prev_content    Json

  editor_nickname String @db.VarChar(64)

  edit_dt         DateTime @default(now())

  board           Board    @relation(fields: [board_id], references: [id], onDelete: Cascade)

  @@index([board_id])
  @@map("board_history")
}


model File {
  id            BigInt       @id @default(autoincrement())
  file_md5      String       @unique
  original_name String?
  extension     String
  size          BigInt
  s3_key        String
  status        FileStatus   @default(uploaded)
  need_optimize Boolean      @default(true)
  ref_count     Int          @default(0)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  sessions      UploadSession[]

  @@map("file")
}

model UploadSession {
  id            BigInt       @id @default(autoincrement())
  file_md5      String
  original_name String?
  extension     String
  size          BigInt
  s3_key        String
  status        UploadStatus @default(pending)
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt


  user_id       BigInt
  user          Users  @relation(fields: [user_id], references: [character_id], onDelete: Cascade)


  file_id       BigInt?
  file          File?        @relation(fields: [file_id], references: [id], onDelete: SetNull)

  @@index([file_md5, status, created_at])
  @@index([file_id])
  @@index([user_id]) 
  @@map("uploadSession") 
}

model BoardLike {
  id Int @id @default(autoincrement())
  user_id BigInt
  board_id BigInt
  created_at DateTime @default(now())

  user Users @relation(fields: [user_id],references: [character_id],onDelete: Cascade)
  board Board @relation(fields: [board_id],references: [id],onDelete: Cascade)
  @@unique([user_id, board_id])
  @@index([board_id])
  @@index([user_id])
  @@map("boardLike")
}

model Comment {
  id BigInt @id  @default(autoincrement())
  user_id BigInt
  board_id BigInt
  content String @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  is_deleted Int @default(0) @db.TinyInt

  user Users @relation("Comment/User",fields: [user_id],references: [character_id],onDelete: Cascade)
  board Board @relation("Comment/Board",fields: [board_id],references: [id],onDelete: Cascade)

  @@index([board_id, created_at])
  @@map("comment")
}