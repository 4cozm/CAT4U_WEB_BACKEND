name: Deploy API (PM2, GCP)

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy over SSH (git pull â†’ npm ci â†’ pm2 reload)
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USER }}
                  key: ${{ secrets.SSH_KEY }}
                  port: 22
                  script: |
                      set -euo pipefail

                      # â–¼ í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìµœì´ˆ clone)
                      if [ ! -d "/srv/cat4u-api/.git" ]; then
                        sudo mkdir -p /srv/cat4u-api
                        sudo chown -R $USER:$USER /srv/cat4u-api
                        git clone https://github.com/<YOUR_ORG>/<YOUR_REPO>.git /srv/cat4u-api
                      fi
                      cd /srv/cat4u-api

                      # â–¼ ìµœì‹  ì½”ë“œ ë°˜ì˜
                      git fetch --all
                      git reset --hard origin/main

                      # â–¼ Node ì„¤ì • (í•„ìš”í•˜ë©´ nvm/node ê²½ë¡œ ë³´ì •)
                      export NODE_ENV=production

                      # â–¼ ì˜ì¡´ì„± ì„¤ì¹˜ (ì¬í˜„ì„± ìœ„í•´ npm ci)
                      npm ci --only=production

                      # â–¼ PM2 ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘(í´ëŸ¬ìŠ¤í„° 2ê°œ ì´ìƒì¼ ë•Œ íš¨ê³¼ì )
                      pm2 reload cat4u-api --update-env || pm2 start app.js --name cat4u-api -i 2 --env production

                      # â–¼ ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì €ì¥
                      pm2 save

            # âœ… Discord ì•Œë¦¼ (ì„±ê³µ)
            - name: Notify Discord (Success)
              if: success()
              env:
                  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  SHA_SHORT="${GITHUB_SHA::7}"
                  cat > payload.json <<'JSON'
                  {
                    "embeds": [{
                      "title": "ğŸš€ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ",
                      "description": "ë¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\n[â–¶ ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})",
                      "color": 5763719
                    }]
                  }
                  JSON
                  sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
                  sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
                  sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
                  curl -sS -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"

            # âŒ Discord ì•Œë¦¼ (ì‹¤íŒ¨)
            - name: Notify Discord (Failure)
              if: failure()
              env:
                  WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  SHA_SHORT="${GITHUB_SHA::7}"
                  cat > payload.json <<'JSON'
                  {
                    "embeds": [{
                      "title": "ğŸ”¥ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨",
                      "description": "ë¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\n[â–¶ ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})",
                      "color": 15548997
                    }]
                  }
                  JSON
                  sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
                  sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
                  sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
                  curl -sS -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"
