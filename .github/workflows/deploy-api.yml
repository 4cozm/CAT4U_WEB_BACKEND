name: Deploy API (PM2)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH (git pull â†’ npm ci â†’ pm2 reload)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}      # ì˜ˆ: 34.22.81.250
          username: ${{ secrets.SSH_USER }}  # ì˜ˆ: ubuntu
          key: ${{ secrets.SSH_KEY }}        # OpenSSH ê°œì¸í‚¤ ì „ì²´
          script: |
            set -Eeuo pipefail

            # í•„ìš”í•œ ë„êµ¬
            command -v git >/dev/null 2>&1 || { sudo apt-get update -y && sudo apt-get install -y git; }
            command -v pm2 >/dev/null 2>&1 || sudo npm i -g pm2

            # ìµœì´ˆ í´ë¡  (ê³µê°œ ë ˆí¬)
            if [ ! -d "/CAT4U_WEB_BACKEND/src/.git" ]; then
              sudo mkdir -p /CAT4U_WEB_BACKEND/src
              sudo chown -R "$USER:$USER" /CAT4U_WEB_BACKEND
              git clone "https://github.com/4cozm/CAT4U_WEB_BACKEND.git" "/CAT4U_WEB_BACKEND/src"
            fi

            cd /CAT4U_WEB_BACKEND/src
            git fetch --all
            git checkout main
            git reset --hard origin/main

            export NODE_ENV=production
            npm ci --only=production

            # PM2 ë¬´ì¤‘ë‹¨ ìž¬ì‹œìž‘(ì—†ìœ¼ë©´ ì‹œìž‘)
            pm2 reload cat4u-backend --update-env || pm2 start server.js --name cat4u-backend -i 2 --env production
            pm2 save

      # âœ… Discord ì•Œë¦¼ (ì„±ê³µ)
      - name: Notify Discord (Success)
        if: success()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          cat > payload.json <<'JSON'
          {
            "embeds": [{
              "title": "ðŸš€ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ",
              "description": "ë¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\n[â–¶ ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})",
              "color": 5763719
            }]
          }
          JSON
          sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
          sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
          sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
          curl -sS -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"

      # âŒ Discord ì•Œë¦¼ (ì‹¤íŒ¨)
      - name: Notify Discord (Failure)
        if: failure()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          cat > payload.json <<'JSON'
          {
            "embeds": [{
              "title": "ðŸ”¥ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨",
              "description": "ë¦¬í¬ì§€í† ë¦¬: ${REPO}\nì»¤ë°‹: ${SHA}\n[â–¶ ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${RUN_URL})",
              "color": 15548997
            }]
          }
          JSON
          sed -i "s|\${REPO}|${GITHUB_REPOSITORY}|g" payload.json
          sed -i "s|\${SHA}|${SHA_SHORT}|g" payload.json
          sed -i "s|\${RUN_URL}|https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|g" payload.json
          curl -sS -H "Content-Type: application/json" -X POST -d @payload.json "$WEBHOOK"
